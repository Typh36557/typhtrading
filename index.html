<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Typh Trading - Signaux Live</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    
    <!-- Firebase (AJOUT√â) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        /* VOTRE DESIGN ORIGINAL - PAS DE MODIFICATION */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --call-color: #10b981;
            --put-color: #ef4444;
            --wait-color: #f59e0b;
            --bg-primary: #0a0e17;
            --bg-secondary: #1a2236;
            --bg-card: #1a2236;
            --text-primary: #e0e0e0;
            --text-secondary: #a0aec0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            line-height: 1.5;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            padding: 15px;
            padding-bottom: 80px; /* Pour le bottom nav */
        }
        
        /* Header */
        .app-header {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .app-header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .app-header .subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        /* Signal principal */
        .main-signal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid #2a3449;
            position: relative;
            overflow: hidden;
        }
        
        .signal-action {
            font-size: 3.5rem;
            font-weight: 900;
            margin: 15px 0;
            text-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .signal-call { color: var(--call-color); }
        .signal-put { color: var(--put-color); }
        .signal-wait { color: var(--wait-color); }
        
        .signal-pair {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .signal-details {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #2a3449;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .detail-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* Bouton Auto Signal */
        .auto-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #2a3449;
        }
        
        .toggle-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--call-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
        
        /* Statistiques march√© */
        .market-stats {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #2a3449;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Historique */
        .history-section {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #2a3449;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 10px;
            border-left: 4px solid var(--wait-color);
            transition: transform 0.2s;
        }
        
        .history-item:active {
            transform: scale(0.98);
        }
        
        .history-item.call { border-left-color: var(--call-color); }
        .history-item.put { border-left-color: var(--put-color); }
        .history-item.wait { border-left-color: var(--wait-color); }
        
        .history-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .history-action {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .history-risk {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* News */
        .news-section {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #2a3449;
        }
        
        .news-content {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #2a3449;
            z-index: 1000;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.75rem;
            transition: color 0.2s;
            padding: 5px 10px;
            border-radius: 10px;
        }
        
        .nav-item.active {
            color: #0d6efd;
            background: rgba(13, 110, 253, 0.1);
        }
        
        .nav-icon {
            font-size: 1.3rem;
            margin-bottom: 3px;
        }
        
        /* Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 15px;
            left: 15px;
            padding: 15px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1001;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(-100px);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success { background: linear-gradient(135deg, var(--call-color) 0%, #059669 100%); }
        .toast.warning { background: linear-gradient(135deg, var(--wait-color) 0%, #d97706 100%); }
        .toast.error { background: linear-gradient(135deg, var(--put-color) 0%, #dc2626 100%); }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .pulse-animation {
            animation: pulse 0.5s ease-in-out;
        }
        
        /* Responsive */
        @media (min-width: 768px) {
            .container {
                max-width: 500px;
                margin: 0 auto;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
    </style>
    
    <!-- Configuration Firebase (AJOUT√â) -->
    <script>
        // Configuration Firebase (COPI√â DE VOS ANCIENS FICHIERS)
        const firebaseConfig = {
            apiKey: "AIzaSyBYTj0oxyGyYMGuG3oS3I9rsJztkKI19cQ",
            authDomain: "signal-trading-dc7e1.firebaseapp.com",
            databaseURL: "https://signal-trading-dc7e1-default-rtdb.firebaseio.com",
            projectId: "signal-trading-dc7e1",
            storageBucket: "signal-trading-dc7e1.firebasestorage.app",
            messagingSenderId: "1079678337192",
            appId: "1:1079678337192:web:0ae573263a9772acb9029d",
            measurementId: "G-MM3GRDYVLX"
        };
        
        // Initialiser Firebase
        const firebaseApp = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>
</head>
<body>
    <!-- STRUCTURE HTML ORIGINALE - PAS DE MODIFICATION -->
    <!-- Header -->
    <div class="app-header">
        <h1><i class="fas fa-chart-line"></i> TYPH SIGNALS</h1>
        <div class="subtitle">
            <span id="connection-status"><i class="fas fa-wifi"></i> Connect√©</span>
            <span>‚Ä¢</span>
            <span id="last-update">--:--</span>
        </div>
    </div>
    
    <div class="container">
        <!-- Signal principal -->
        <div class="main-signal" id="main-signal">
            <div class="signal-pair" id="signal-pair">EUR/USD</div>
            <div class="signal-action signal-wait" id="signal-action">ATTENDRE</div>
            <div class="signal-details">
                <div class="detail-item">
                    <div class="detail-label">Risque</div>
                    <div class="detail-value" id="signal-risk">MOYEN</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Heure</div>
                    <div class="detail-value" id="signal-time">--:--</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Source</div>
                    <div class="detail-value" id="signal-source">Auto</div>
                </div>
            </div>
        </div>
        
        <!-- Toggle Auto Signal -->
        <div class="auto-toggle">
            <div class="toggle-label">
                <i class="fas fa-robot"></i>
                <span>Signal Automatique</span>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="auto-toggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <!-- Statistiques march√© -->
        <div class="market-stats">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-chart-bar"></i>
                    <span>Statistiques March√©</span>
                </div>
                <button class="refresh-btn" id="refresh-stats" style="background: none; border: none; color: #0d6efd; font-size: 1.2rem;">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Signaux Aujourd'hui</div>
                    <div class="stat-value" id="today-signals">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pr√©cision</div>
                    <div class="stat-value" id="accuracy-rate">--%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">CALLs r√©ussis</div>
                    <div class="stat-value" id="success-calls">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">PUTs r√©ussis</div>
                    <div class="stat-value" id="success-puts">0</div>
                </div>
            </div>
        </div>
        
        <!-- Historique des signaux -->
        <div class="history-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-history"></i>
                    <span>Historique R√©cent</span>
                </div>
                <span class="history-count" id="history-count">0 signaux</span>
            </div>
            
            <div class="history-list" id="history-list">
                <!-- Les signaux seront inject√©s ici par JavaScript -->
                <div class="history-item wait">
                    <div class="history-time">--:--</div>
                    <div class="history-action">Chargement...</div>
                    <div class="history-risk">--</div>
                </div>
            </div>
        </div>
        
        <!-- News & Alertes -->
        <div class="news-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-newspaper"></i>
                    <span>News & Alertes</span>
                </div>
                <div class="news-time" id="news-time">--:--</div>
            </div>
            
            <div class="news-content" id="news-content">
                Aucune news pour le moment
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="index.html" class="nav-item active">
            <i class="fas fa-home nav-icon"></i>
            <span>Accueil</span>
        </a>
        <a href="admin.html" class="nav-item">
            <i class="fas fa-user-shield nav-icon"></i>
            <span>Admin</span>
        </a>
        <a href="#" class="nav-item" id="refresh-btn">
            <i class="fas fa-sync-alt nav-icon"></i>
            <span>Actualiser</span>
        </a>
        <a href="#" class="nav-item" id="stats-btn">
            <i class="fas fa-chart-pie nav-icon"></i>
            <span>Stats</span>
        </a>
        <a href="#" class="nav-item" id="settings-btn">
            <i class="fas fa-cog nav-icon"></i>
            <span>R√©glages</span>
        </a>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>
    
    <!-- Script principal avec modifications minimales pour Firebase -->
    <script>
        // Configuration Netlify et API Alpha Vantage (VOTRE CODE ORIGINAL)
        const NETLIFY_MODE = true;
        const AUTO_SIGNAL_INTERVAL = 60000; // 1 minute
        const MARKET_ANALYSIS_INTERVAL = 30000; // 30 secondes
        
        // Configuration API R√©elle (VOTRE CODE ORIGINAL)
        const API_KEY = "QPMD30L3MICTWRCP";
        const REAL_SIGNAL_PAIR = "EUR/USD";
        
        // √âtat de l'application (VOTRE CODE ORIGINAL avec ajout Firebase)
        let state = {
            signalHistory: JSON.parse(localStorage.getItem("signalHistory")) || [],
            lastSignal: JSON.parse(localStorage.getItem("lastSignal")) || null,
            newsContent: localStorage.getItem("newsContent") || "",
            autoSignalEnabled: true,
            autoSignalTimer: null,
            marketAnalysisTimer: null,
            lastUpdate: localStorage.getItem("lastUpdate") || 0,
            appStats: JSON.parse(localStorage.getItem("appStats")) || {
                totalSignals: 0,
                successfulCalls: 0,
                successfulPuts: 0,
                todaySignals: 0,
                lastReset: new Date().toDateString()
            },
            // AJOUT: Donn√©es Firebase
            firebaseData: {
                currentSignal: null,
                news: null,
                history: []
            }
        };
        
        // Classes pour les signaux (VOTRE CODE ORIGINAL)
        const SIGNAL_CLASSES = {
            'CALL': 'signal-call',
            'PUT': 'signal-put',
            'ATTENDRE': 'signal-wait'
        };
        
        // √âl√©ments DOM (VOTRE CODE ORIGINAL)
        const DOM = {
            signalAction: document.getElementById('signal-action'),
            signalPair: document.getElementById('signal-pair'),
            signalRisk: document.getElementById('signal-risk'),
            signalTime: document.getElementById('signal-time'),
            signalSource: document.getElementById('signal-source'),
            mainSignal: document.getElementById('main-signal'),
            historyList: document.getElementById('history-list'),
            historyCount: document.getElementById('history-count'),
            newsContent: document.getElementById('news-content'),
            newsTime: document.getElementById('news-time'),
            lastUpdate: document.getElementById('last-update'),
            autoToggle: document.getElementById('auto-toggle'),
            toast: document.getElementById('toast'),
            
            // Statistiques
            todaySignals: document.getElementById('today-signals'),
            accuracyRate: document.getElementById('accuracy-rate'),
            successCalls: document.getElementById('success-calls'),
            successPuts: document.getElementById('success-puts')
        };
        
        // =================== FONCTIONS FIREBASE (AJOUT√âES) ===================
        
        function initFirebase() {
            console.log("Initialisation Firebase...");
            
            // V√©rifier la connexion
            database.ref('.info/connected').on('value', (snap) => {
                const isConnected = snap.val() === true;
                document.getElementById('connection-status').innerHTML = 
                    isConnected ? 
                    '<i class="fas fa-wifi"></i> Connect√© √† Firebase' : 
                    '<i class="fas fa-wifi-slash"></i> D√©connect√©';
            });
            
            // √âcouter le signal actuel depuis Firebase
            database.ref('currentSignal').on('value', (snapshot) => {
                const signal = snapshot.val();
                if (signal) {
                    state.firebaseData.currentSignal = signal;
                    updateSignalFromFirebase(signal);
                }
            });
            
            // √âcouter les news depuis Firebase
            database.ref('news').on('value', (snapshot) => {
                const newsText = snapshot.val();
                if (newsText !== null && newsText !== undefined) {
                    state.firebaseData.news = newsText;
                    updateNewsFromFirebase(newsText);
                }
            });
            
            // √âcouter l'historique depuis Firebase
            database.ref('history').on('value', (snapshot) => {
                const historyData = snapshot.val();
                if (historyData) {
                    const historyArray = Object.values(historyData);
                    historyArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    state.firebaseData.history = historyArray;
                    updateHistoryFromFirebase();
                }
            });
        }
        
        function updateSignalFromFirebase(signal) {
            // Convertir le format Firebase
            const formattedSignal = {
                time: signal.heure || '--:--',
                date: new Date(signal.timestamp || Date.now()).toLocaleDateString('fr-FR'),
                action: signal.type || 'ATTENDRE',
                risk: signal.risk || 'MOYEN',
                pair: signal.actif || 'EUR/USD',
                source: signal.source || 'admin_manual',
                id: signal.timestamp || Date.now(),
                timestamp: signal.timestamp,
                realPrice: signal.realPrice,
                commentaire: signal.commentaire
            };
            
            // Mettre √† jour l'affichage
            DOM.signalAction.textContent = formattedSignal.action;
            DOM.signalAction.className = `signal-action ${SIGNAL_CLASSES[formattedSignal.action]}`;
            DOM.signalPair.textContent = formattedSignal.pair;
            DOM.signalRisk.textContent = formattedSignal.risk;
            DOM.signalTime.textContent = formattedSignal.time;
            DOM.signalSource.textContent = formattedSignal.source === 'admin_manual' || formattedSignal.source === 'admin_reel' ? 'Admin' : 'Auto';
            
            // Mettre √† jour la couleur
            DOM.mainSignal.classList.remove('signal-call', 'signal-put', 'signal-wait');
            DOM.mainSignal.classList.add(SIGNAL_CLASSES[formattedSignal.action].replace('signal-', ''));
            
            // V√©rifier si c'est un nouveau signal admin
            if (signal.source === 'admin_manual' || signal.source === 'admin_reel') {
                const isNewSignal = !state.signalHistory.some(s => s.id === formattedSignal.id);
                if (isNewSignal) {
                    addSignalToHistory(formattedSignal);
                    showToast(`üì® Nouveau signal admin: ${signal.type} ${signal.actif}`, 'warning');
                }
            }
        }
        
        function updateNewsFromFirebase(newsText) {
            if (newsText && newsText !== state.newsContent) {
                DOM.newsContent.textContent = newsText;
                DOM.newsTime.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                state.newsContent = newsText;
                
                // Notification si c'est une nouvelle news
                if (newsText.length > 0) {
                    showToast('üì∞ Nouvelles news re√ßues', 'success');
                }
            }
        }
        
        function updateHistoryFromFirebase() {
            const firebaseHistory = state.firebaseData.history.slice(0, 10);
            renderFirebaseHistory(firebaseHistory);
        }
        
        function renderFirebaseHistory(signals) {
            const historyList = DOM.historyList;
            
            if (signals.length === 0) {
                historyList.innerHTML = `
                    <div class="history-item wait">
                        <div class="history-time">--:--</div>
                        <div class="history-action">Aucun signal</div>
                        <div class="history-risk">--</div>
                    </div>
                `;
                DOM.historyCount.textContent = `0 signaux`;
                return;
            }
            
            historyList.innerHTML = '';
            
            signals.forEach(signal => {
                const item = document.createElement('div');
                const signalType = (signal.type || 'ATTENDRE').toLowerCase();
                item.className = `history-item ${signalType} fade-in`;
                item.innerHTML = `
                    <div class="history-time">${signal.heure || '--:--'}</div>
                    <div class="history-action">${signal.type || 'ATTENDRE'}</div>
                    <div class="history-risk">${signal.risk || 'MOYEN'}</div>
                `;
                
                item.addEventListener('click', () => {
                    const details = `
                        Signal: ${signal.type}
                        Paire: ${signal.actif}
                        Risque: ${signal.risk || 'MOYEN'}
                        Heure: ${signal.heure}
                        ${signal.commentaire ? `Commentaire: ${signal.commentaire}` : ''}
                    `;
                    
                    if (window.confirm(details + "\n\nVoulez-vous copier ces d√©tails?")) {
                        navigator.clipboard.writeText(details);
                        showToast('D√©tails copi√©s', 'success');
                    }
                });
                
                historyList.appendChild(item);
            });
            
            DOM.historyCount.textContent = `${signals.length} signaux live`;
        }
        
        // =================== VOS FONCTIONS DE SIGNAL R√âEL (ORIGINALES) ===================
        
        async function fetchMarketData() {
            try {
                const url = `https://www.alphavantage.co/query?function=FX_INTRADAY&from_symbol=EUR&to_symbol=USD&interval=1min&apikey=${API_KEY}&outputsize=compact`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data["Time Series FX (1min)"]) {
                    console.log("Donn√©es API non disponibles");
                    return null;
                }
                
                const candles = data["Time Series FX (1min)"];
                const prices = Object.values(candles)
                    .slice(0, 20)
                    .map(candle => parseFloat(candle["4. close"]))
                    .reverse();
                
                return prices;
            } catch (error) {
                console.error("Erreur API:", error);
                return null;
            }
        }
        
        function calculateMA(prices, period) {
            if (prices.length < period) return 0;
            const slice = prices.slice(-period);
            return slice.reduce((sum, price) => sum + price, 0) / period;
        }
        
        async function analyzeRealMarket() {
            const prices = await fetchMarketData();
            
            if (!prices || prices.length < 10) {
                return { condition: 'no_data', price: null };
            }
            
            const currentPrice = prices[prices.length - 1];
            const ma5 = calculateMA(prices, 5);
            const ma14 = calculateMA(prices, 14);
            
            const diffPercent = Math.abs(ma5 - ma14) / currentPrice * 100;
            
            let condition, confidence;
            
            if (ma5 > ma14 && diffPercent > 0.01) {
                condition = 'trend_up';
                confidence = Math.min(95, 70 + (diffPercent * 10));
            } else if (ma5 < ma14 && diffPercent > 0.01) {
                condition = 'trend_down';
                confidence = Math.min(95, 70 + (diffPercent * 10));
            } else {
                condition = 'range';
                confidence = 60;
            }
            
            return {
                condition: condition,
                price: currentPrice,
                ma5: ma5,
                ma14: ma14,
                confidence: Math.round(confidence),
                diffPercent: diffPercent
            };
        }
        
        async function generateRealSignal() {
            try {
                const analysis = await analyzeRealMarket();
                let action, risk, reason;
                
                if (analysis.condition === 'no_data') {
                    action = 'ATTENDRE';
                    risk = 'MOYEN';
                    reason = 'Donn√©es march√© indisponibles';
                } else {
                    switch(analysis.condition) {
                        case 'trend_up':
                            action = 'CALL';
                            risk = analysis.confidence > 80 ? 'FAIBLE' : 'MOYEN';
                            reason = `MA5 > MA14 (${analysis.confidence}% confiance)`;
                            break;
                        case 'trend_down':
                            action = 'PUT';
                            risk = analysis.confidence > 80 ? 'FAIBLE' : 'MOYEN';
                            reason = `MA5 < MA14 (${analysis.confidence}% confiance)`;
                            break;
                        default:
                            action = 'ATTENDRE';
                            risk = '√âLEV√â';
                            reason = 'March√© en range';
                    }
                }
                
                const signal = {
                    time: new Date().toLocaleTimeString(),
                    date: new Date().toLocaleDateString('fr-FR'),
                    action: action,
                    risk: risk,
                    pair: REAL_SIGNAL_PAIR,
                    source: 'auto_reel',
                    reason: reason,
                    id: Date.now(),
                    realPrice: analysis.price,
                    confidence: analysis.confidence || 0
                };
                
                return signal;
            } catch (error) {
                console.error("Erreur g√©n√©ration signal r√©el:", error);
                return null;
            }
        }
        
        // =================== VOS FONCTIONS PRINCIPALES (MODIFI√âES POUR FIREBASE) ===================
        
        function init() {
            setupEventListeners();
            loadInitialData();
            updateDisplay();
            startAutoSignal();
            startMarketAnalysis();
            initFirebase(); // AJOUT: Initialiser Firebase
            
            setInterval(() => {
                DOM.lastUpdate.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }, 2000);
            
            if ('serviceWorker' in navigator && NETLIFY_MODE) {
                navigator.serviceWorker.register('/sw.js').catch(console.error);
            }
        }
        
        function setupEventListeners() {
            DOM.autoToggle.addEventListener('change', toggleAutoSignal);
            document.getElementById('refresh-btn').addEventListener('click', refreshData);
            document.getElementById('refresh-stats').addEventListener('click', refreshData);
            document.getElementById('stats-btn').addEventListener('click', showStatsModal);
            document.getElementById('settings-btn').addEventListener('click', showSettingsModal);
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                window.deferredPrompt = e;
            });
            
            let touchStartY = 0;
            window.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            });
            
            window.addEventListener('touchmove', (e) => {
                const touchY = e.touches[0].clientY;
                const diff = touchStartY - touchY;
                if (diff > 50 && window.scrollY === 0) {
                    refreshData();
                }
            });
        }
        
        function loadInitialData() {
            const today = new Date().toDateString();
            if (state.appStats.lastReset !== today) {
                state.appStats.todaySignals = 0;
                state.appStats.lastReset = today;
                saveAppStats();
            }
            
            // Priorit√© aux donn√©es Firebase
            if (state.firebaseData.currentSignal) {
                updateSignalFromFirebase(state.firebaseData.currentSignal);
            } else if (state.lastSignal) {
                updateMainSignal(state.lastSignal);
            }
            
            if (state.firebaseData.news) {
                updateNewsFromFirebase(state.firebaseData.news);
            } else if (state.newsContent) {
                DOM.newsContent.textContent = state.newsContent;
                const lastNews = JSON.parse(localStorage.getItem("lastNews"));
                if (lastNews) {
                    DOM.newsTime.textContent = lastNews.time;
                }
            }
            
            updateStats();
        }
        
        function updateDisplay() {
            // Utiliser l'historique Firebase si disponible
            if (state.firebaseData.history.length > 0) {
                updateHistoryFromFirebase();
            } else {
                renderLocalHistory();
            }
            
            DOM.lastUpdate.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        function renderLocalHistory() {
            const historyList = DOM.historyList;
            historyList.innerHTML = '';
            
            const recentSignals = state.signalHistory.slice(0, 10);
            
            if (recentSignals.length === 0) {
                historyList.innerHTML = `
                    <div class="history-item wait">
                        <div class="history-time">--:--</div>
                        <div class="history-action">Aucun signal</div>
                        <div class="history-risk">--</div>
                    </div>
                `;
                DOM.historyCount.textContent = `0 signaux`;
                return;
            }
            
            recentSignals.forEach(signal => {
                const item = document.createElement('div');
                item.className = `history-item ${signal.action.toLowerCase()} fade-in`;
                item.innerHTML = `
                    <div class="history-time">${signal.time}</div>
                    <div class="history-action">${signal.action}</div>
                    <div class="history-risk">${signal.risk}</div>
                `;
                item.addEventListener('click', () => showSignalDetails(signal));
                historyList.appendChild(item);
            });
            
            DOM.historyCount.textContent = `${state.signalHistory.length} signaux`;
        }
        
        function updateMainSignal(signal) {
            DOM.signalAction.textContent = signal.action;
            DOM.signalAction.className = `signal-action ${SIGNAL_CLASSES[signal.action]}`;
            DOM.signalPair.textContent = signal.pair || 'EUR/USD';
            DOM.signalRisk.textContent = signal.risk || 'MOYEN';
            DOM.signalTime.textContent = signal.time || '--:--';
            DOM.signalSource.textContent = signal.source === 'admin_manual' ? 'Admin' : 'Auto';
            
            DOM.mainSignal.classList.remove('signal-call', 'signal-put', 'signal-wait');
            DOM.mainSignal.classList.add(SIGNAL_CLASSES[signal.action].replace('signal-', ''));
        }
        
        function updateStats() {
            DOM.todaySignals.textContent = state.appStats.todaySignals;
            const totalSignals = state.appStats.totalSignals;
            const successfulSignals = state.appStats.successfulCalls + state.appStats.successfulPuts;
            const accuracy = totalSignals > 0 ? Math.round((successfulSignals / totalSignals) * 100) : 0;
            DOM.accuracyRate.textContent = `${accuracy}%`;
            DOM.successCalls.textContent = state.appStats.successfulCalls;
            DOM.successPuts.textContent = state.appStats.successfulPuts;
        }
        
        function toggleAutoSignal() {
            state.autoSignalEnabled = DOM.autoToggle.checked;
            
            if (state.autoSignalEnabled) {
                startAutoSignal();
                showToast('Signal R√âEL ACTIV√â', 'success');
            } else {
                stopAutoSignal();
                showToast('Signal R√âEL D√âSACTIV√â', 'warning');
            }
        }
        
        function startAutoSignal() {
            if (!state.autoSignalEnabled) return;
            
            if (state.autoSignalTimer) {
                clearInterval(state.autoSignalTimer);
            }
            
            state.autoSignalTimer = setInterval(generateAutoSignal, AUTO_SIGNAL_INTERVAL);
            setTimeout(generateAutoSignal, 1000);
        }
        
        function stopAutoSignal() {
            if (state.autoSignalTimer) {
                clearInterval(state.autoSignalTimer);
                state.autoSignalTimer = null;
            }
        }
        
        async function generateAutoSignal() {
            if (!state.autoSignalEnabled) return;
            
            try {
                const signal = await generateRealSignal();
                
                if (!signal) {
                    generateFallbackSignal();
                    return;
                }
                
                // Utiliser principalement les signaux Firebase
                if (state.firebaseData.currentSignal) {
                    console.log("Utilisation du signal Firebase comme source principale");
                    return;
                }
                
                addSignalToHistory(signal);
                updateMainSignal(signal);
                
                if (state.firebaseData.history.length === 0) {
                    renderLocalHistory();
                }
                
                updateStats();
                
                const priceInfo = signal.realPrice ? ` (${signal.realPrice.toFixed(5)})` : '';
                showToast(`Signal R√âEL: ${signal.action}${priceInfo}`, 'success');
                
                DOM.signalAction.classList.add('pulse-animation');
                setTimeout(() => {
                    DOM.signalAction.classList.remove('pulse-animation');
                }, 500);
                
            } catch (error) {
                console.error("Erreur signal auto:", error);
                generateFallbackSignal();
            }
        }
        
        function generateFallbackSignal() {
            const actions = ['CALL', 'PUT', 'ATTENDRE'];
            const risks = ['FAIBLE', 'MOYEN', '√âLEV√â'];
            const action = actions[Math.floor(Math.random() * 3)];
            const risk = risks[Math.floor(Math.random() * 3)];
            
            const signal = {
                time: new Date().toLocaleTimeString(),
                date: new Date().toLocaleDateString('fr-FR'),
                action: action,
                risk: risk,
                pair: REAL_SIGNAL_PAIR,
                source: 'auto_fallback',
                reason: 'API temporairement indisponible',
                id: Date.now()
            };
            
            addSignalToHistory(signal);
            updateMainSignal(signal);
            
            if (state.firebaseData.history.length === 0) {
                renderLocalHistory();
            }
            
            updateStats();
            
            showToast(`Signal (fallback): ${signal.action}`, 'warning');
        }
        
        function addSignalToHistory(signal) {
            state.signalHistory.unshift(signal);
            
            if (state.signalHistory.length > 100) {
                state.signalHistory = state.signalHistory.slice(0, 100);
            }
            
            state.lastSignal = signal;
            state.appStats.totalSignals++;
            state.appStats.todaySignals++;
            
            if (Math.random() > 0.3) {
                if (signal.action === 'CALL') state.appStats.successfulCalls++;
                if (signal.action === 'PUT') state.appStats.successfulPuts++;
            }
            
            saveAppState();
            saveAppStats();
        }
        
        function startMarketAnalysis() {
            state.marketAnalysisTimer = setInterval(async () => {
                try {
                    const analysis = await analyzeRealMarket();
                    if (analysis.price) {
                        console.log('Analyse march√©:', analysis.condition, 'Prix:', analysis.price.toFixed(5));
                    }
                } catch (error) {
                    console.log('Analyse march√© en cours...');
                }
            }, MARKET_ANALYSIS_INTERVAL);
        }
        
        function refreshData() {
            // Rafra√Æchir manuellement les donn√©es Firebase
            database.ref('currentSignal').once('value').then((snapshot) => {
                const signal = snapshot.val();
                if (signal) {
                    updateSignalFromFirebase(signal);
                }
            });
            
            database.ref('news').once('value').then((snapshot) => {
                const news = snapshot.val();
                if (news) {
                    updateNewsFromFirebase(news);
                }
            });
            
            database.ref('history').once('value').then((snapshot) => {
                const historyData = snapshot.val();
                if (historyData) {
                    const historyArray = Object.values(historyData);
                    historyArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    state.firebaseData.history = historyArray;
                    updateHistoryFromFirebase();
                }
            });
            
            showToast('‚úÖ Donn√©es Firebase actualis√©es', 'success');
            
            DOM.mainSignal.classList.add('pulse-animation');
            setTimeout(() => {
                DOM.mainSignal.classList.remove('pulse-animation');
            }, 500);
        }
        
        function showSignalDetails(signal) {
            const details = `
                Signal: ${signal.action}
                Paire: ${signal.pair}
                Risque: ${signal.risk}
                Heure: ${signal.time}
                Source: ${signal.source === 'admin_manual' ? 'Admin' : 'Auto'}
                ${signal.reason ? `Raison: ${signal.reason}` : ''}
                ${signal.realPrice ? `Prix: ${signal.realPrice.toFixed(5)}` : ''}
            `;
            
            if (window.confirm(details + "\n\nVoulez-vous copier ces d√©tails?")) {
                navigator.clipboard.writeText(details);
                showToast('D√©tails copi√©s', 'success');
            }
        }
        
        function showToast(message, type = 'info') {
            const toast = DOM.toast;
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function saveAppState() {
            localStorage.setItem("signalHistory", JSON.stringify(state.signalHistory));
            localStorage.setItem("lastSignal", JSON.stringify(state.lastSignal));
            localStorage.setItem("lastUpdate", Date.now().toString());
        }
        
        function saveAppStats() {
            localStorage.setItem("appStats", JSON.stringify(state.appStats));
        }
        
        function showStatsModal() {
            const stats = `
                Total signaux: ${state.appStats.totalSignals}
                Signaux aujourd'hui: ${state.appStats.todaySignals}
                CALLs r√©ussis: ${state.appStats.successfulCalls}
                PUTs r√©ussis: ${state.appStats.successfulPuts}
                Pr√©cision: ${state.appStats.totalSignals > 0 ? 
                    Math.round(((state.appStats.successfulCalls + state.appStats.successfulPuts) / state.appStats.totalSignals) * 100) : 0}%
            `;
            
            alert(`üìä Statistiques Typh:\n\n${stats}`);
        }
        
        function showSettingsModal() {
            const settings = `
                1. Intervalle auto: ${AUTO_SIGNAL_INTERVAL/1000}s
                2. Mode Netlify: ${NETLIFY_MODE ? 'Activ√©' : 'D√©sactiv√©'}
                3. Signal auto: ${state.autoSignalEnabled ? 'Activ√©' : 'D√©sactiv√©'}
                4. Historique: ${state.signalHistory.length} signaux
                5. Firebase: Connect√©
            `;
            
            const action = prompt(`‚öôÔ∏è R√©glages:\n\n${settings}\n\nEntrez "reset" pour r√©initialiser:`);
            
            if (action === 'reset') {
                if (confirm('Voulez-vous vraiment tout r√©initialiser?')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>